// <auto-generated />

// Copyright (c) .NET Foundation. All rights reserved.
// Licensed under the Apache License, Version 2.0. See License.txt in the project root for license information.

using System;
using System.Collections.Generic;
using System.IO;
using System.Threading.Tasks;
using NuGet.Insights;

namespace NuGet.Insights.Worker.PackageCompatibilityToCsv
{
    /* Kusto DDL:

    .drop table PackageCompatibilities ifexists;

    .create table PackageCompatibilities (
        LowerId: string,
        Identity: string,
        Id: string,
        Version: string,
        CatalogCommitTimestamp: datetime,
        Created: datetime,
        ResultType: string,
        HasError: bool,
        DoesNotRoundTrip: bool,
        HasAny: bool,
        HasUnsupported: bool,
        HasAgnostic: bool,
        BrokenFrameworks: dynamic,
        NuspecReader: dynamic,
        NU1202: dynamic,
        NuGetGallery: dynamic,
        NuGetGalleryEscaped: dynamic,
        NuGetGallerySupported: dynamic,
        NuGetGalleryBadges: dynamic
    ) with (docstring = "See https://github.com/NuGet/Insights/blob/main/docs/tables/PackageCompatibilities.md", folder = "");

    .alter-merge table PackageCompatibilities policy retention softdelete = 30d;

    .alter table PackageCompatibilities policy partitioning '{'
      '"PartitionKeys": ['
        '{'
          '"ColumnName": "Identity",'
          '"Kind": "Hash",'
          '"Properties": {'
            '"Function": "XxHash64",'
            '"MaxPartitionCount": 256'
          '}'
        '}'
      ']'
    '}';

    .create table PackageCompatibilities ingestion csv mapping 'BlobStorageMapping'
    '['
        '{"Column":"LowerId","DataType":"string","Properties":{"Ordinal":2}},'
        '{"Column":"Identity","DataType":"string","Properties":{"Ordinal":3}},'
        '{"Column":"Id","DataType":"string","Properties":{"Ordinal":4}},'
        '{"Column":"Version","DataType":"string","Properties":{"Ordinal":5}},'
        '{"Column":"CatalogCommitTimestamp","DataType":"datetime","Properties":{"Ordinal":6}},'
        '{"Column":"Created","DataType":"datetime","Properties":{"Ordinal":7}},'
        '{"Column":"ResultType","DataType":"string","Properties":{"Ordinal":8}},'
        '{"Column":"HasError","DataType":"bool","Properties":{"Ordinal":9}},'
        '{"Column":"DoesNotRoundTrip","DataType":"bool","Properties":{"Ordinal":10}},'
        '{"Column":"HasAny","DataType":"bool","Properties":{"Ordinal":11}},'
        '{"Column":"HasUnsupported","DataType":"bool","Properties":{"Ordinal":12}},'
        '{"Column":"HasAgnostic","DataType":"bool","Properties":{"Ordinal":13}},'
        '{"Column":"BrokenFrameworks","DataType":"dynamic","Properties":{"Ordinal":14}},'
        '{"Column":"NuspecReader","DataType":"dynamic","Properties":{"Ordinal":15}},'
        '{"Column":"NU1202","DataType":"dynamic","Properties":{"Ordinal":16}},'
        '{"Column":"NuGetGallery","DataType":"dynamic","Properties":{"Ordinal":17}},'
        '{"Column":"NuGetGalleryEscaped","DataType":"dynamic","Properties":{"Ordinal":18}},'
        '{"Column":"NuGetGallerySupported","DataType":"dynamic","Properties":{"Ordinal":19}},'
        '{"Column":"NuGetGalleryBadges","DataType":"dynamic","Properties":{"Ordinal":20}}'
    ']'

    */
    partial record PackageCompatibility
    {
        public int FieldCount => 21;

        public void WriteHeader(TextWriter writer)
        {
            writer.WriteLine("ScanId,ScanTimestamp,LowerId,Identity,Id,Version,CatalogCommitTimestamp,Created,ResultType,HasError,DoesNotRoundTrip,HasAny,HasUnsupported,HasAgnostic,BrokenFrameworks,NuspecReader,NU1202,NuGetGallery,NuGetGalleryEscaped,NuGetGallerySupported,NuGetGalleryBadges");
        }

        public void Write(List<string> fields)
        {
            fields.Add(ScanId.ToString());
            fields.Add(CsvUtility.FormatDateTimeOffset(ScanTimestamp));
            fields.Add(LowerId);
            fields.Add(Identity);
            fields.Add(Id);
            fields.Add(Version);
            fields.Add(CsvUtility.FormatDateTimeOffset(CatalogCommitTimestamp));
            fields.Add(CsvUtility.FormatDateTimeOffset(Created));
            fields.Add(ResultType.ToString());
            fields.Add(CsvUtility.FormatBool(HasError));
            fields.Add(CsvUtility.FormatBool(DoesNotRoundTrip));
            fields.Add(CsvUtility.FormatBool(HasAny));
            fields.Add(CsvUtility.FormatBool(HasUnsupported));
            fields.Add(CsvUtility.FormatBool(HasAgnostic));
            fields.Add(BrokenFrameworks);
            fields.Add(NuspecReader);
            fields.Add(NU1202);
            fields.Add(NuGetGallery);
            fields.Add(NuGetGalleryEscaped);
            fields.Add(NuGetGallerySupported);
            fields.Add(NuGetGalleryBadges);
        }

        public void Write(TextWriter writer)
        {
            writer.Write(ScanId);
            writer.Write(',');
            writer.Write(CsvUtility.FormatDateTimeOffset(ScanTimestamp));
            writer.Write(',');
            CsvUtility.WriteWithQuotes(writer, LowerId);
            writer.Write(',');
            CsvUtility.WriteWithQuotes(writer, Identity);
            writer.Write(',');
            CsvUtility.WriteWithQuotes(writer, Id);
            writer.Write(',');
            CsvUtility.WriteWithQuotes(writer, Version);
            writer.Write(',');
            writer.Write(CsvUtility.FormatDateTimeOffset(CatalogCommitTimestamp));
            writer.Write(',');
            writer.Write(CsvUtility.FormatDateTimeOffset(Created));
            writer.Write(',');
            CsvUtility.WriteWithQuotes(writer, ResultType.ToString());
            writer.Write(',');
            writer.Write(CsvUtility.FormatBool(HasError));
            writer.Write(',');
            writer.Write(CsvUtility.FormatBool(DoesNotRoundTrip));
            writer.Write(',');
            writer.Write(CsvUtility.FormatBool(HasAny));
            writer.Write(',');
            writer.Write(CsvUtility.FormatBool(HasUnsupported));
            writer.Write(',');
            writer.Write(CsvUtility.FormatBool(HasAgnostic));
            writer.Write(',');
            CsvUtility.WriteWithQuotes(writer, BrokenFrameworks);
            writer.Write(',');
            CsvUtility.WriteWithQuotes(writer, NuspecReader);
            writer.Write(',');
            CsvUtility.WriteWithQuotes(writer, NU1202);
            writer.Write(',');
            CsvUtility.WriteWithQuotes(writer, NuGetGallery);
            writer.Write(',');
            CsvUtility.WriteWithQuotes(writer, NuGetGalleryEscaped);
            writer.Write(',');
            CsvUtility.WriteWithQuotes(writer, NuGetGallerySupported);
            writer.Write(',');
            CsvUtility.WriteWithQuotes(writer, NuGetGalleryBadges);
            writer.WriteLine();
        }

        public async Task WriteAsync(TextWriter writer)
        {
            await writer.WriteAsync(ScanId.ToString());
            await writer.WriteAsync(',');
            await writer.WriteAsync(CsvUtility.FormatDateTimeOffset(ScanTimestamp));
            await writer.WriteAsync(',');
            await CsvUtility.WriteWithQuotesAsync(writer, LowerId);
            await writer.WriteAsync(',');
            await CsvUtility.WriteWithQuotesAsync(writer, Identity);
            await writer.WriteAsync(',');
            await CsvUtility.WriteWithQuotesAsync(writer, Id);
            await writer.WriteAsync(',');
            await CsvUtility.WriteWithQuotesAsync(writer, Version);
            await writer.WriteAsync(',');
            await writer.WriteAsync(CsvUtility.FormatDateTimeOffset(CatalogCommitTimestamp));
            await writer.WriteAsync(',');
            await writer.WriteAsync(CsvUtility.FormatDateTimeOffset(Created));
            await writer.WriteAsync(',');
            await CsvUtility.WriteWithQuotesAsync(writer, ResultType.ToString());
            await writer.WriteAsync(',');
            await writer.WriteAsync(CsvUtility.FormatBool(HasError));
            await writer.WriteAsync(',');
            await writer.WriteAsync(CsvUtility.FormatBool(DoesNotRoundTrip));
            await writer.WriteAsync(',');
            await writer.WriteAsync(CsvUtility.FormatBool(HasAny));
            await writer.WriteAsync(',');
            await writer.WriteAsync(CsvUtility.FormatBool(HasUnsupported));
            await writer.WriteAsync(',');
            await writer.WriteAsync(CsvUtility.FormatBool(HasAgnostic));
            await writer.WriteAsync(',');
            await CsvUtility.WriteWithQuotesAsync(writer, BrokenFrameworks);
            await writer.WriteAsync(',');
            await CsvUtility.WriteWithQuotesAsync(writer, NuspecReader);
            await writer.WriteAsync(',');
            await CsvUtility.WriteWithQuotesAsync(writer, NU1202);
            await writer.WriteAsync(',');
            await CsvUtility.WriteWithQuotesAsync(writer, NuGetGallery);
            await writer.WriteAsync(',');
            await CsvUtility.WriteWithQuotesAsync(writer, NuGetGalleryEscaped);
            await writer.WriteAsync(',');
            await CsvUtility.WriteWithQuotesAsync(writer, NuGetGallerySupported);
            await writer.WriteAsync(',');
            await CsvUtility.WriteWithQuotesAsync(writer, NuGetGalleryBadges);
            await writer.WriteLineAsync();
        }

        public ICsvRecord ReadNew(Func<string> getNextField)
        {
            return new PackageCompatibility
            {
                ScanId = CsvUtility.ParseNullable(getNextField(), Guid.Parse),
                ScanTimestamp = CsvUtility.ParseNullable(getNextField(), CsvUtility.ParseDateTimeOffset),
                LowerId = getNextField(),
                Identity = getNextField(),
                Id = getNextField(),
                Version = getNextField(),
                CatalogCommitTimestamp = CsvUtility.ParseDateTimeOffset(getNextField()),
                Created = CsvUtility.ParseNullable(getNextField(), CsvUtility.ParseDateTimeOffset),
                ResultType = Enum.Parse<PackageCompatibilityResultType>(getNextField()),
                HasError = bool.Parse(getNextField()),
                DoesNotRoundTrip = bool.Parse(getNextField()),
                HasAny = bool.Parse(getNextField()),
                HasUnsupported = bool.Parse(getNextField()),
                HasAgnostic = bool.Parse(getNextField()),
                BrokenFrameworks = getNextField(),
                NuspecReader = getNextField(),
                NU1202 = getNextField(),
                NuGetGallery = getNextField(),
                NuGetGalleryEscaped = getNextField(),
                NuGetGallerySupported = getNextField(),
                NuGetGalleryBadges = getNextField(),
            };
        }

        public void SetEmptyStrings()
        {
            if (LowerId is null)
            {
                LowerId = string.Empty;
            }

            if (Identity is null)
            {
                Identity = string.Empty;
            }

            if (Id is null)
            {
                Id = string.Empty;
            }

            if (Version is null)
            {
                Version = string.Empty;
            }

            if (BrokenFrameworks is null)
            {
                BrokenFrameworks = string.Empty;
            }

            if (NuspecReader is null)
            {
                NuspecReader = string.Empty;
            }

            if (NU1202 is null)
            {
                NU1202 = string.Empty;
            }

            if (NuGetGallery is null)
            {
                NuGetGallery = string.Empty;
            }

            if (NuGetGalleryEscaped is null)
            {
                NuGetGalleryEscaped = string.Empty;
            }

            if (NuGetGallerySupported is null)
            {
                NuGetGallerySupported = string.Empty;
            }

            if (NuGetGalleryBadges is null)
            {
                NuGetGalleryBadges = string.Empty;
            }
        }
    }
}
